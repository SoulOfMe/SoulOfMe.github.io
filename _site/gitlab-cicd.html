<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitLab CICD</title>
    <meta name="description" content="Runnerã€Stagesã€Artifactsã€å˜é‡ä¸éƒ¨ç½²çš„ç³»ç»Ÿå®è·µ">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        :root{--bg:#f3f4f6;--card:#ffffff;--text:#1f2937;--muted:#6b7280;--link:#2563eb;--border:#e5e7eb}
        html.dark{--bg:#0b1220;--card:#0f172a;--text:#e5e7eb;--muted:#9ca3af;--link:#60a5fa;--border:#1f2937}
        html{scroll-behavior:smooth}
        body{background:var(--bg);color:var(--text)}
        header,footer{background:var(--card)}
        .card{background:var(--card)}
        .nav-link{color:var(--muted);transition:color .2s ease}
        .nav-link:hover{color:var(--link)}
        .brand{color:var(--text);transition:color .2s ease}
        .brand:hover{color:var(--link)}
        .btn{display:inline-flex;align-items:center;gap:.5rem;border:1px solid var(--border);padding:.5rem .75rem;border-radius:.5rem;background:var(--card);color:var(--text);transition:transform .1s ease,background .2s ease}
        .btn:active{transform:scale(.98)}
        .prose h1,.prose h2,.prose h3{color:var(--text)}
        .prose p{color:var(--muted)}
        pre{position:relative;background:var(--card);border:1px solid var(--border);border-radius:.5rem;padding:1rem}
        .copy-btn{position:absolute;top:.5rem;right:.5rem;font-size:.875rem}
        #backToTop{position:fixed;bottom:2rem;right:2rem;display:none}
    </style>
</head>
<body class="bg-gray-100 font-sans leading-normal tracking-normal">

    <header class="shadow-md">
        <nav class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="text-xl font-semibold">
                    <a href="/" class="brand">Soul Of Me åšå®¢</a>
                </div>
                <div class="flex items-center gap-2">
                    <button id="menuToggle" class="btn md:hidden" aria-label="æ‰“å¼€èœå•">èœå•</button>
                    <button id="themeToggle" class="btn" aria-label="åˆ‡æ¢ä¸»é¢˜">ğŸŒ™</button>
                </div>
            </div>
            <div id="navLinks" class="mt-3 hidden md:flex items-center">
                <a href="/how-to-start.html" class="nav-link px-3 py-2">å¦‚ä½•å¼€å§‹</a>
                <a href="/faq.html" class="nav-link px-3 py-2">FAQ</a>
                <a href="/contributing.html" class="nav-link px-3 py-2">è´¡çŒ®æŒ‡å—</a>
                <a href="/a-new-post.html" class="nav-link px-3 py-2">ä¸€ç¯‡æ–°æ–‡ç« </a>
            </div>
        </nav>
    </header>

    <main class="container w-full md:max-w-3xl mx-auto pt-10 pb-20 px-6">
        <div class="card p-8 rounded-lg shadow-lg">
            <h1 class="text-3xl font-bold mb-4">GitLab CICD</h1>
            <div class="prose lg:prose-xl">
                <h2 id="æ¦‚è¿°">æ¦‚è¿°</h2>

<p>GitLab CI/CD ä»¥ <code class="language-plaintext highlighter-rouge">.gitlab-ci.yml</code> æè¿°æµæ°´çº¿ï¼Œé€šè¿‡ Runner æ‰§è¡Œ Jobã€‚åˆç†è®¾è®¡é˜¶æ®µä¸åˆ¶å“å¯å®ç°æ„å»ºã€æµ‹è¯•ã€å‘å¸ƒçš„è‡ªåŠ¨åŒ–é—­ç¯ã€‚</p>

<h2 id="runner-ä¸æ‰§è¡Œç¯å¢ƒ">Runner ä¸æ‰§è¡Œç¯å¢ƒ</h2>

<p>Runner ç±»å‹ï¼šShellã€Dockerã€Kubernetesã€‚æ¨èä½¿ç”¨ Docker Runner ä»¥éš”ç¦»ç¯å¢ƒã€‚</p>

<p>æ³¨å†Œï¼š</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gitlab-runner register
</code></pre></div></div>

<p>ç¤ºä¾‹é…ç½®ï¼ˆDocker Runnerï¼‰ï¼š</p>

<div class="language-toml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">[[</span><span class="n">runners</span><span class="k">]]</span>
  <span class="n">name</span> <span class="o">=</span><span class="w"> </span><span class="s">"docker-runner"</span>
  <span class="n">url</span> <span class="o">=</span><span class="w"> </span><span class="s">"https://gitlab.com/"</span>
  <span class="n">token</span> <span class="o">=</span><span class="w"> </span><span class="s">"TOKEN"</span>
  <span class="n">executor</span> <span class="o">=</span><span class="w"> </span><span class="s">"docker"</span>
  <span class="k">[</span><span class="n">runners</span><span class="k">.</span><span class="n">docker</span><span class="k">]</span>
    <span class="n">image</span> <span class="o">=</span><span class="w"> </span><span class="s">"docker:24"</span>
    <span class="n">privileged</span> <span class="o">=</span><span class="w"> </span><span class="kc">true</span>
    <span class="n">volumes</span> <span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s">"/var/run/docker.sock:/var/run/docker.sock"</span><span class="p">,</span><span class="s">"/cache"</span><span class="p">]</span>
</code></pre></div></div>

<h2 id="gitlab-ciyml-ç»“æ„"><code class="language-plaintext highlighter-rouge">.gitlab-ci.yml</code> ç»“æ„</h2>

<p>å…³é”®å…ƒç´ ï¼š<code class="language-plaintext highlighter-rouge">stages</code>ã€<code class="language-plaintext highlighter-rouge">jobs</code>ã€<code class="language-plaintext highlighter-rouge">image</code>ã€<code class="language-plaintext highlighter-rouge">services</code>ã€<code class="language-plaintext highlighter-rouge">artifacts</code>ã€<code class="language-plaintext highlighter-rouge">cache</code>ã€<code class="language-plaintext highlighter-rouge">rules</code>ã€<code class="language-plaintext highlighter-rouge">only/except</code>ã€<code class="language-plaintext highlighter-rouge">variables</code>ã€‚</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">stages</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">build</span>
  <span class="pi">-</span> <span class="s">test</span>
  <span class="pi">-</span> <span class="s">release</span>

<span class="na">variables</span><span class="pi">:</span>
  <span class="na">DOCKER_DRIVER</span><span class="pi">:</span> <span class="s">overlay2</span>

<span class="na">build</span><span class="pi">:</span>
  <span class="na">stage</span><span class="pi">:</span> <span class="s">build</span>
  <span class="na">image</span><span class="pi">:</span> <span class="s">node:20-alpine</span>
  <span class="na">script</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">npm ci</span>
    <span class="pi">-</span> <span class="s">npm run build</span>
  <span class="na">artifacts</span><span class="pi">:</span>
    <span class="na">paths</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">dist/</span>
    <span class="na">expire_in</span><span class="pi">:</span> <span class="s">1 week</span>

<span class="na">test</span><span class="pi">:</span>
  <span class="na">stage</span><span class="pi">:</span> <span class="s">test</span>
  <span class="na">image</span><span class="pi">:</span> <span class="s">node:20-alpine</span>
  <span class="na">needs</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">build"</span><span class="pi">]</span>
  <span class="na">script</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">npm test -- --ci</span>
  <span class="na">dependencies</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">build</span>

<span class="na">release</span><span class="pi">:</span>
  <span class="na">stage</span><span class="pi">:</span> <span class="s">release</span>
  <span class="na">image</span><span class="pi">:</span> <span class="s">docker:24</span>
  <span class="na">services</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">docker:24-dind</span>
  <span class="na">rules</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">if</span><span class="pi">:</span> <span class="s">$CI_COMMIT_TAG</span>
  <span class="na">script</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">docker build -t registry.example.com/app:$CI_COMMIT_TAG .</span>
    <span class="pi">-</span> <span class="s">docker push registry.example.com/app:$CI_COMMIT_TAG</span>
</code></pre></div></div>

<h2 id="å˜é‡ä¸å¯†é’¥ç®¡ç†">å˜é‡ä¸å¯†é’¥ç®¡ç†</h2>

<p>åœ¨é¡¹ç›®æˆ–ç»„çš„ CI/CD Settings ä¸­è®¾ç½® <code class="language-plaintext highlighter-rouge">Variables</code>ï¼ŒåŒºåˆ† <code class="language-plaintext highlighter-rouge">Protected</code> ä¸ <code class="language-plaintext highlighter-rouge">Masked</code>ã€‚åœ¨æµæ°´çº¿ä¸­ä»¥ç¯å¢ƒå˜é‡è¯»å–ã€‚</p>

<p>ç¤ºä¾‹ï¼š<code class="language-plaintext highlighter-rouge">REGISTRY_USER</code>ã€<code class="language-plaintext highlighter-rouge">REGISTRY_PASSWORD</code>ã€<code class="language-plaintext highlighter-rouge">KUBE_CONFIG</code>ã€‚</p>

<h2 id="ç¼“å­˜ä¸åˆ¶å“">ç¼“å­˜ä¸åˆ¶å“</h2>

<p><code class="language-plaintext highlighter-rouge">cache</code> é€‚åˆä¾èµ–ç¼“å­˜ï¼ˆå¦‚ <code class="language-plaintext highlighter-rouge">node_modules</code>ï¼‰ï¼›<code class="language-plaintext highlighter-rouge">artifacts</code> ç”¨äºè·¨ Job ä¼ é€’æ„å»ºäº§ç‰©ã€‚</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">cache</span><span class="pi">:</span>
  <span class="na">paths</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">node_modules/</span>
  <span class="na">key</span><span class="pi">:</span> <span class="s">${CI_COMMIT_REF_SLUG}</span>
</code></pre></div></div>

<h2 id="docker-é•œåƒæ„å»ºä¸å®‰å…¨">Docker é•œåƒæ„å»ºä¸å®‰å…¨</h2>

<p>åœ¨ Docker Runner ä¸­é€šè¿‡ <code class="language-plaintext highlighter-rouge">docker:dind</code> æ„å»ºé•œåƒï¼›å»ºè®®å›ºå®šåŸºç¡€é•œåƒç‰ˆæœ¬å¹¶å¯ç”¨é•œåƒæ‰«æã€‚</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">release</span><span class="pi">:</span>
  <span class="na">stage</span><span class="pi">:</span> <span class="s">release</span>
  <span class="na">image</span><span class="pi">:</span> <span class="s">docker:24</span>
  <span class="na">services</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">docker:24-dind</span>
  <span class="na">variables</span><span class="pi">:</span>
    <span class="na">DOCKER_TLS_CERTDIR</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
  <span class="na">script</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">docker login -u $REGISTRY_USER -p $REGISTRY_PASSWORD registry.example.com</span>
    <span class="pi">-</span> <span class="s">docker build -t registry.example.com/app:$CI_COMMIT_SHA .</span>
    <span class="pi">-</span> <span class="s">docker push registry.example.com/app:$CI_COMMIT_SHA</span>
</code></pre></div></div>

<h2 id="éƒ¨ç½²ç­–ç•¥">éƒ¨ç½²ç­–ç•¥</h2>

<p>ç¯å¢ƒä¸æ‰‹åŠ¨é—¨ç¦ï¼š</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">deploy_staging</span><span class="pi">:</span>
  <span class="na">stage</span><span class="pi">:</span> <span class="s">release</span>
  <span class="na">when</span><span class="pi">:</span> <span class="s">manual</span>
  <span class="na">environment</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">staging</span>
    <span class="na">url</span><span class="pi">:</span> <span class="s">https://staging.example.com</span>
  <span class="na">script</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">./scripts/deploy-staging.sh</span>

<span class="na">deploy_prod</span><span class="pi">:</span>
  <span class="na">stage</span><span class="pi">:</span> <span class="s">release</span>
  <span class="na">when</span><span class="pi">:</span> <span class="s">manual</span>
  <span class="na">environment</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">production</span>
    <span class="na">url</span><span class="pi">:</span> <span class="s">https://example.com</span>
  <span class="na">script</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">./scripts/deploy-prod.sh</span>
</code></pre></div></div>

<h2 id="è§¦å‘è§„åˆ™ä¸åˆ†æ”¯ç­–ç•¥">è§¦å‘è§„åˆ™ä¸åˆ†æ”¯ç­–ç•¥</h2>

<p>ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">rules</code> ç²¾ç¡®æ§åˆ¶è§¦å‘ï¼š</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">rules</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">if</span><span class="pi">:</span> <span class="s">$CI_PIPELINE_SOURCE == "merge_request_event"</span>
  <span class="pi">-</span> <span class="na">if</span><span class="pi">:</span> <span class="s">$CI_COMMIT_BRANCH == "main"</span>
</code></pre></div></div>

<h2 id="è‡ªåŠ¨åŒ–æµ‹è¯•ä¸æŠ¥å‘Š">è‡ªåŠ¨åŒ–æµ‹è¯•ä¸æŠ¥å‘Š</h2>

<p>å¯ç”Ÿæˆ JUnit æˆ–è¦†ç›–ç‡æŠ¥å‘Šå¹¶åœ¨ GitLab æ˜¾ç¤ºï¼š</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">test</span><span class="pi">:</span>
  <span class="na">stage</span><span class="pi">:</span> <span class="s">test</span>
  <span class="na">script</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">npm test -- --ci --reporter=junit --coverage</span>
  <span class="na">artifacts</span><span class="pi">:</span>
    <span class="na">reports</span><span class="pi">:</span>
      <span class="na">junit</span><span class="pi">:</span> <span class="s">junit.xml</span>
    <span class="na">paths</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">coverage/</span>
</code></pre></div></div>

<h2 id="å¸¸è§é—®é¢˜ä¸æœ€ä½³å®è·µ">å¸¸è§é—®é¢˜ä¸æœ€ä½³å®è·µ</h2>

<ul>
  <li>å›ºåŒ–é•œåƒä¸ä¾èµ–ç‰ˆæœ¬ï¼Œé¿å…ä¸å¯æ§çš„ <code class="language-plaintext highlighter-rouge">latest</code></li>
  <li>ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">needs</code> å‡å°‘ä¸å¿…è¦çš„æ‹‰å–ä¸ç­‰å¾…</li>
  <li>æ˜ç¡®åˆ†æ”¯ä¸æ ‡ç­¾ç­–ç•¥ï¼ŒåŒºåˆ†é¢„å‘å¸ƒä¸æ­£å¼å‘å¸ƒ</li>
  <li>Runner æƒé™æœ€å°åŒ–ï¼Œæ•æ„Ÿå˜é‡è®¾ä¸º <code class="language-plaintext highlighter-rouge">Protected</code> å¹¶ä»…åœ¨å—ä¿æŠ¤åˆ†æ”¯ä½¿ç”¨</li>
</ul>

<h2 id="æ¨¡æ¿ç¤ºä¾‹">æ¨¡æ¿ç¤ºä¾‹</h2>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">stages</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">build</span><span class="pi">,</span> <span class="nv">test</span><span class="pi">,</span> <span class="nv">release</span><span class="pi">]</span>

<span class="na">.default_job</span><span class="pi">:</span>
  <span class="na">image</span><span class="pi">:</span> <span class="s">node:20-alpine</span>
  <span class="na">cache</span><span class="pi">:</span>
    <span class="na">paths</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">node_modules/</span><span class="pi">]</span>

<span class="na">build</span><span class="pi">:</span>
  <span class="na">stage</span><span class="pi">:</span> <span class="s">build</span>
  <span class="na">extends</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">.default_job</span><span class="pi">]</span>
  <span class="na">script</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">npm</span><span class="nv"> </span><span class="s">ci"</span><span class="pi">,</span><span class="s2">"</span><span class="s">npm</span><span class="nv"> </span><span class="s">run</span><span class="nv"> </span><span class="s">build"</span><span class="pi">]</span>
  <span class="na">artifacts</span><span class="pi">:</span>
    <span class="na">paths</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">dist/</span><span class="pi">]</span>

<span class="na">test</span><span class="pi">:</span>
  <span class="na">stage</span><span class="pi">:</span> <span class="s">test</span>
  <span class="na">extends</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">.default_job</span><span class="pi">]</span>
  <span class="na">needs</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">build</span><span class="pi">]</span>
  <span class="na">script</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">npm</span><span class="nv"> </span><span class="s">test</span><span class="nv"> </span><span class="s">--</span><span class="nv"> </span><span class="s">--ci"</span><span class="pi">]</span>

<span class="na">release</span><span class="pi">:</span>
  <span class="na">stage</span><span class="pi">:</span> <span class="s">release</span>
  <span class="na">image</span><span class="pi">:</span> <span class="s">docker:24</span>
  <span class="na">services</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">docker:24-dind"</span><span class="pi">]</span>
  <span class="na">rules</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">if</span><span class="pi">:</span> <span class="s">$CI_COMMIT_TAG</span>
  <span class="na">script</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">docker login -u $REGISTRY_USER -p $REGISTRY_PASSWORD registry.example.com</span>
    <span class="pi">-</span> <span class="s">docker build -t registry.example.com/app:$CI_COMMIT_TAG .</span>
    <span class="pi">-</span> <span class="s">docker push registry.example.com/app:$CI_COMMIT_TAG</span>
</code></pre></div></div>

<h2 id="æ€»ç»“">æ€»ç»“</h2>

<p>é€šè¿‡åˆç†çš„ Runner é…ç½®ã€é˜¶æ®µåˆ’åˆ†ã€å˜é‡ä¸åˆ¶å“ç®¡ç†ï¼ŒGitLab CI/CD å¯å®ç°ç¨³å®šã€å¯å®¡è®¡çš„æŒç»­äº¤ä»˜æµæ°´çº¿ï¼Œå¹¶åœ¨å¤šç¯å¢ƒéƒ¨ç½²ä¸­ä¿æŒä¸€è‡´æ€§ä¸å®‰å…¨æ€§ã€‚</p>

            </div>
        </div>
    </main>

    <footer class="mt-10">
        <div class="container mx-auto px-6 py-4 text-center text-gray-600">
            <p>&copy; 2024 Soul Of Me åšå®¢. All rights reserved.</p>
        </div>
    </footer>

    <button id="backToTop" class="btn">è¿”å›é¡¶éƒ¨</button>

    <script>
        ;(function(){
            var stored=localStorage.getItem('theme');
            var prefers=window.matchMedia('(prefers-color-scheme: dark)').matches?'dark':'light';
            var initial=stored||prefers;
            if(initial==='dark')document.documentElement.classList.add('dark');
            var themeBtn=document.getElementById('themeToggle');
            if(themeBtn){
                themeBtn.textContent=document.documentElement.classList.contains('dark')?'â˜€ï¸':'ğŸŒ™';
                themeBtn.addEventListener('click',function(){
                    document.documentElement.classList.toggle('dark');
                    var isDark=document.documentElement.classList.contains('dark');
                    localStorage.setItem('theme',isDark?'dark':'light');
                    themeBtn.textContent=isDark?'â˜€ï¸':'ğŸŒ™';
                });
            }
            var menuBtn=document.getElementById('menuToggle');
            var navLinks=document.getElementById('navLinks');
            if(menuBtn&&navLinks){
                menuBtn.addEventListener('click',function(){
                    if(navLinks.classList.contains('hidden')){navLinks.classList.remove('hidden')}else{navLinks.classList.add('hidden')}
                });
            }
            var back=document.getElementById('backToTop');
            if(back){
                window.addEventListener('scroll',function(){
                    if(window.scrollY>300){back.style.display='block'}else{back.style.display='none'}
                });
                back.addEventListener('click',function(){window.scrollTo({top:0,behavior:'smooth'})});
            }
            var codes=document.querySelectorAll('pre > code');
            codes.forEach(function(code){
                var btn=document.createElement('button');
                btn.className='btn copy-btn';
                btn.textContent='å¤åˆ¶';
                btn.addEventListener('click',function(){
                    var text=code.innerText;
                    navigator.clipboard.writeText(text).then(function(){btn.textContent='å·²å¤åˆ¶';setTimeout(function(){btn.textContent='å¤åˆ¶'},1500)});
                });
                code.parentElement.appendChild(btn);
            });
        })();
    </script>

</body>
</html>
