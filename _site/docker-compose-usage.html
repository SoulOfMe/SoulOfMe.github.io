<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Docker Composeä½¿ç”¨</title>
    <meta name="description" content="ä»å…¥é—¨åˆ°å¤šç¯å¢ƒç¼–æ’çš„å®Œæ•´å®è·µæŒ‡å—">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        :root{--bg:#f3f4f6;--card:#ffffff;--text:#1f2937;--muted:#6b7280;--link:#2563eb;--border:#e5e7eb}
        html.dark{--bg:#0b1220;--card:#0f172a;--text:#e5e7eb;--muted:#9ca3af;--link:#60a5fa;--border:#1f2937}
        html{scroll-behavior:smooth}
        body{background:var(--bg);color:var(--text)}
        header,footer{background:var(--card)}
        .card{background:var(--card)}
        .nav-link{color:var(--muted);transition:color .2s ease}
        .nav-link:hover{color:var(--link)}
        .brand{color:var(--text);transition:color .2s ease}
        .brand:hover{color:var(--link)}
        .btn{display:inline-flex;align-items:center;gap:.5rem;border:1px solid var(--border);padding:.5rem .75rem;border-radius:.5rem;background:var(--card);color:var(--text);transition:transform .1s ease,background .2s ease}
        .btn:active{transform:scale(.98)}
        .prose h1,.prose h2,.prose h3{color:var(--text)}
        .prose p{color:var(--muted)}
        pre{position:relative;background:var(--card);border:1px solid var(--border);border-radius:.5rem;padding:1rem}
        .copy-btn{position:absolute;top:.5rem;right:.5rem;font-size:.875rem}
        #backToTop{position:fixed;bottom:2rem;right:2rem;display:none}
    </style>
</head>
<body class="bg-gray-100 font-sans leading-normal tracking-normal">

    <header class="shadow-md">
        <nav class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="text-xl font-semibold">
                    <a href="/" class="brand">Soul Of Me åšå®¢</a>
                </div>
                <div class="flex items-center gap-2">
                    <button id="menuToggle" class="btn md:hidden" aria-label="æ‰“å¼€èœå•">èœå•</button>
                    <button id="themeToggle" class="btn" aria-label="åˆ‡æ¢ä¸»é¢˜">ğŸŒ™</button>
                </div>
            </div>
            <div id="navLinks" class="mt-3 hidden md:flex items-center">
                <a href="/how-to-start.html" class="nav-link px-3 py-2">å¦‚ä½•å¼€å§‹</a>
                <a href="/faq.html" class="nav-link px-3 py-2">FAQ</a>
                <a href="/contributing.html" class="nav-link px-3 py-2">è´¡çŒ®æŒ‡å—</a>
                <a href="/a-new-post.html" class="nav-link px-3 py-2">ä¸€ç¯‡æ–°æ–‡ç« </a>
            </div>
        </nav>
    </header>

    <main class="container w-full md:max-w-3xl mx-auto pt-10 pb-20 px-6">
        <div class="card p-8 rounded-lg shadow-lg">
            <h1 class="text-3xl font-bold mb-4">Docker Composeä½¿ç”¨</h1>
            <div class="prose lg:prose-xl">
                <h2 id="æ¦‚è¿°">æ¦‚è¿°</h2>

<p>Docker Compose ç”¨äºå®šä¹‰å’Œè¿è¡Œå¤šå®¹å™¨åº”ç”¨ã€‚é€šè¿‡ä¸€ä¸ª <code class="language-plaintext highlighter-rouge">compose.yml</code> æ–‡ä»¶å³å¯æè¿°æœåŠ¡ã€ç½‘ç»œã€å·ä¸ä¾èµ–å…³ç³»ï¼Œä¾¿äºæœ¬åœ°å¼€å‘ä¸å¤šç¯å¢ƒä¸€è‡´åŒ–éƒ¨ç½²ã€‚</p>

<h2 id="å®‰è£…ä¸å¿«é€Ÿå¼€å§‹">å®‰è£…ä¸å¿«é€Ÿå¼€å§‹</h2>

<h3 id="å®‰è£…">å®‰è£…</h3>

<p>macOS ä¸ Windows çš„ Docker Desktop é»˜è®¤å†…ç½® Composeï¼›Linux å¯é€šè¿‡åŒ…ç®¡ç†å™¨å®‰è£… <code class="language-plaintext highlighter-rouge">docker compose</code> å­å‘½ä»¤ã€‚</p>

<h3 id="æœ€å°ç¤ºä¾‹">æœ€å°ç¤ºä¾‹</h3>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">services</span><span class="pi">:</span>
  <span class="na">web</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">nginx:1.25</span>
    <span class="na">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">8080:80"</span>
</code></pre></div></div>

<p>è¿è¡Œä¸æŸ¥çœ‹çŠ¶æ€ï¼š</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker compose up <span class="nt">-d</span>
docker compose ps
docker compose logs <span class="nt">-f</span> web
</code></pre></div></div>

<h2 id="composeyml-ç»“æ„ä¸å…³é”®å­—æ®µ"><code class="language-plaintext highlighter-rouge">compose.yml</code> ç»“æ„ä¸å…³é”®å­—æ®µ</h2>

<p>å¸¸ç”¨å­—æ®µï¼š<code class="language-plaintext highlighter-rouge">image</code>ã€<code class="language-plaintext highlighter-rouge">build</code>ã€<code class="language-plaintext highlighter-rouge">ports</code>ã€<code class="language-plaintext highlighter-rouge">environment</code>ã€<code class="language-plaintext highlighter-rouge">volumes</code>ã€<code class="language-plaintext highlighter-rouge">depends_on</code>ã€<code class="language-plaintext highlighter-rouge">networks</code>ã€<code class="language-plaintext highlighter-rouge">healthcheck</code>ã€‚</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">services</span><span class="pi">:</span>
  <span class="na">api</span><span class="pi">:</span>
    <span class="na">build</span><span class="pi">:</span>
      <span class="na">context</span><span class="pi">:</span> <span class="s">./api</span>
      <span class="na">dockerfile</span><span class="pi">:</span> <span class="s">Dockerfile</span>
    <span class="na">environment</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">NODE_ENV=development</span>
      <span class="pi">-</span> <span class="s">DB_URL=${DB_URL}</span>
    <span class="na">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">3000:3000"</span>
    <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">./api:/app</span>
      <span class="pi">-</span> <span class="s">node_modules:/app/node_modules</span>
    <span class="na">depends_on</span><span class="pi">:</span>
      <span class="na">db</span><span class="pi">:</span>
        <span class="na">condition</span><span class="pi">:</span> <span class="s">service_healthy</span>
  <span class="na">db</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">postgres:16</span>
    <span class="na">environment</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">POSTGRES_PASSWORD=secret</span>
    <span class="na">healthcheck</span><span class="pi">:</span>
      <span class="na">test</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">CMD-SHELL"</span><span class="pi">,</span><span class="s2">"</span><span class="s">pg_isready</span><span class="nv"> </span><span class="s">-U</span><span class="nv"> </span><span class="s">postgres"</span><span class="pi">]</span>
      <span class="na">interval</span><span class="pi">:</span> <span class="s">10s</span>
      <span class="na">timeout</span><span class="pi">:</span> <span class="s">3s</span>
      <span class="na">retries</span><span class="pi">:</span> <span class="m">5</span>
<span class="na">volumes</span><span class="pi">:</span>
  <span class="na">node_modules</span><span class="pi">:</span>
<span class="na">networks</span><span class="pi">:</span>
  <span class="na">default</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">demo-net</span>
</code></pre></div></div>

<h2 id="å¤šç¯å¢ƒé…ç½®">å¤šç¯å¢ƒé…ç½®</h2>

<p>ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">.env</code> ä¸å¤šä¸ª Compose æ–‡ä»¶å åŠ å®ç°ç¯å¢ƒå·®å¼‚ï¼š</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker compose <span class="nt">-f</span> compose.yml <span class="nt">-f</span> compose.prod.yml up <span class="nt">-d</span>
</code></pre></div></div>

<p>ç¤ºä¾‹ï¼š</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># compose.prod.yml</span>
<span class="na">services</span><span class="pi">:</span>
  <span class="na">api</span><span class="pi">:</span>
    <span class="na">environment</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">NODE_ENV=production</span>
    <span class="na">deploy</span><span class="pi">:</span>
      <span class="na">resources</span><span class="pi">:</span>
        <span class="na">limits</span><span class="pi">:</span>
          <span class="na">cpus</span><span class="pi">:</span> <span class="s2">"</span><span class="s">1.0"</span>
          <span class="na">memory</span><span class="pi">:</span> <span class="s">512M</span>
</code></pre></div></div>

<h2 id="å·ä¸æ•°æ®æŒä¹…åŒ–">å·ä¸æ•°æ®æŒä¹…åŒ–</h2>

<ul>
  <li>ç»‘å®šå·ï¼š<code class="language-plaintext highlighter-rouge">./data:/var/lib/postgresql/data</code></li>
  <li>åŒ¿å/å‘½åå·ï¼š<code class="language-plaintext highlighter-rouge">dbdata:/var/lib/postgresql/data</code></li>
</ul>

<p>å¤‡ä»½ä¸æ¢å¤ï¼š</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker compose <span class="nb">exec </span>db pg_dump <span class="nt">-U</span> postgres app <span class="o">&gt;</span> backup.sql
docker compose <span class="nb">exec</span> <span class="nt">-T</span> db psql <span class="nt">-U</span> postgres app &lt; backup.sql
</code></pre></div></div>

<h2 id="ç½‘ç»œä¸æœåŠ¡å‘ç°">ç½‘ç»œä¸æœåŠ¡å‘ç°</h2>

<p>Compose é»˜è®¤åˆ›å»ºéš”ç¦»ç½‘ç»œï¼ŒæœåŠ¡é—´å¯ç”¨æœåŠ¡åäº’ç›¸è®¿é—®ï¼š<code class="language-plaintext highlighter-rouge">api</code> è®¿é—® <code class="language-plaintext highlighter-rouge">db:5432</code>ã€‚</p>

<p>è‡ªå®šä¹‰ç½‘ç»œå¯è®¾ç½® <code class="language-plaintext highlighter-rouge">name</code> ä»¥ä¸å…¶ä»–æ ˆå…±äº«ã€‚</p>

<h2 id="å¥åº·æ£€æŸ¥ä¸ä¾èµ–">å¥åº·æ£€æŸ¥ä¸ä¾èµ–</h2>

<p>é€šè¿‡ <code class="language-plaintext highlighter-rouge">healthcheck</code> ä¸ <code class="language-plaintext highlighter-rouge">depends_on</code> çš„ <code class="language-plaintext highlighter-rouge">condition: service_healthy</code> ä¿è¯ä¾èµ–é¡ºåºä¸ç¨³å®šå¯åŠ¨ã€‚</p>

<h2 id="å¸¸ç”¨å‘½ä»¤é€ŸæŸ¥">å¸¸ç”¨å‘½ä»¤é€ŸæŸ¥</h2>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker compose up <span class="nt">-d</span>
docker compose down
docker compose build <span class="nt">--no-cache</span>
docker compose logs <span class="nt">-f</span> api
docker compose <span class="nb">exec </span>api sh
docker compose pull
docker compose restart api
</code></pre></div></div>

<h2 id="ç”Ÿäº§ç¯å¢ƒå»ºè®®">ç”Ÿäº§ç¯å¢ƒå»ºè®®</h2>

<ul>
  <li>å°†æ•æ„Ÿé…ç½®ç½®äºç¯å¢ƒå˜é‡æˆ–å¯†é’¥ç®¡ç†ï¼Œä¸å†™å…¥é•œåƒ</li>
  <li>å›ºåŒ–ç‰ˆæœ¬ï¼š<code class="language-plaintext highlighter-rouge">image: nginx:1.25.4</code>ï¼Œé¿å… <code class="language-plaintext highlighter-rouge">latest</code></li>
  <li>èµ„æºé™åˆ¶ä¸å¥åº·æ£€æŸ¥å¿…é…</li>
  <li>ä½¿ç”¨åå‘ä»£ç†ä¸è¯ä¹¦è‡ªåŠ¨ç»­æœŸï¼ˆå¦‚ Traefik/Caddyï¼‰</li>
</ul>

<h2 id="æ•…éšœæ’æŸ¥">æ•…éšœæ’æŸ¥</h2>

<p>æ—¥å¿—ã€äº‹ä»¶ä¸å®¹å™¨çŠ¶æ€ç»“åˆå®šä½ï¼š</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker compose logs <span class="nt">--tail</span><span class="o">=</span>200 api
docker events <span class="nt">--since</span> 1h
docker ps <span class="nt">-a</span>
</code></pre></div></div>

<h2 id="å®Œæ•´ç¤ºä¾‹">å®Œæ•´ç¤ºä¾‹</h2>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">services</span><span class="pi">:</span>
  <span class="na">web</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">caddy:2.8</span>
    <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">./site:/srv</span>
      <span class="pi">-</span> <span class="s">./Caddyfile:/etc/caddy/Caddyfile</span>
    <span class="na">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">80:80"</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">443:443"</span>
    <span class="na">depends_on</span><span class="pi">:</span>
      <span class="na">api</span><span class="pi">:</span>
        <span class="na">condition</span><span class="pi">:</span> <span class="s">service_started</span>
  <span class="na">api</span><span class="pi">:</span>
    <span class="na">build</span><span class="pi">:</span>
      <span class="na">context</span><span class="pi">:</span> <span class="s">./api</span>
    <span class="na">environment</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">PORT=3000</span>
    <span class="na">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">3000:3000"</span>
    <span class="na">healthcheck</span><span class="pi">:</span>
      <span class="na">test</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">CMD"</span><span class="pi">,</span><span class="s2">"</span><span class="s">curl"</span><span class="pi">,</span><span class="s2">"</span><span class="s">-f"</span><span class="pi">,</span><span class="s2">"</span><span class="s">http://localhost:3000/health"</span><span class="pi">]</span>
      <span class="na">interval</span><span class="pi">:</span> <span class="s">10s</span>
      <span class="na">timeout</span><span class="pi">:</span> <span class="s">3s</span>
      <span class="na">retries</span><span class="pi">:</span> <span class="m">5</span>
  <span class="na">db</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">postgres:16</span>
    <span class="na">environment</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">POSTGRES_PASSWORD=secret</span>
    <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">dbdata:/var/lib/postgresql/data</span>
<span class="na">volumes</span><span class="pi">:</span>
  <span class="na">dbdata</span><span class="pi">:</span>
</code></pre></div></div>

<h2 id="æ€»ç»“">æ€»ç»“</h2>

<p>ä»¥ Compose ä¸ºæ ¸å¿ƒçš„æœ¬åœ°ä¸å‡†ç”Ÿäº§ç¼–æ’å¯ä»¥ä¿æŒç¯å¢ƒä¸€è‡´æ€§ã€æå‡äº¤ä»˜æ•ˆç‡ï¼Œå¹¶ä¸ºåç»­è¿ç§»è‡³ç¼–æ’ç³»ç»Ÿï¼ˆå¦‚ Swarm/Kubernetesï¼‰æ‰“å¥½åŸºç¡€ã€‚</p>

            </div>
        </div>
    </main>

    <footer class="mt-10">
        <div class="container mx-auto px-6 py-4 text-center text-gray-600">
            <p>&copy; 2024 Soul Of Me åšå®¢. All rights reserved.</p>
        </div>
    </footer>

    <button id="backToTop" class="btn">è¿”å›é¡¶éƒ¨</button>

    <script>
        ;(function(){
            var stored=localStorage.getItem('theme');
            var prefers=window.matchMedia('(prefers-color-scheme: dark)').matches?'dark':'light';
            var initial=stored||prefers;
            if(initial==='dark')document.documentElement.classList.add('dark');
            var themeBtn=document.getElementById('themeToggle');
            if(themeBtn){
                themeBtn.textContent=document.documentElement.classList.contains('dark')?'â˜€ï¸':'ğŸŒ™';
                themeBtn.addEventListener('click',function(){
                    document.documentElement.classList.toggle('dark');
                    var isDark=document.documentElement.classList.contains('dark');
                    localStorage.setItem('theme',isDark?'dark':'light');
                    themeBtn.textContent=isDark?'â˜€ï¸':'ğŸŒ™';
                });
            }
            var menuBtn=document.getElementById('menuToggle');
            var navLinks=document.getElementById('navLinks');
            if(menuBtn&&navLinks){
                menuBtn.addEventListener('click',function(){
                    if(navLinks.classList.contains('hidden')){navLinks.classList.remove('hidden')}else{navLinks.classList.add('hidden')}
                });
            }
            var back=document.getElementById('backToTop');
            if(back){
                window.addEventListener('scroll',function(){
                    if(window.scrollY>300){back.style.display='block'}else{back.style.display='none'}
                });
                back.addEventListener('click',function(){window.scrollTo({top:0,behavior:'smooth'})});
            }
            var codes=document.querySelectorAll('pre > code');
            codes.forEach(function(code){
                var btn=document.createElement('button');
                btn.className='btn copy-btn';
                btn.textContent='å¤åˆ¶';
                btn.addEventListener('click',function(){
                    var text=code.innerText;
                    navigator.clipboard.writeText(text).then(function(){btn.textContent='å·²å¤åˆ¶';setTimeout(function(){btn.textContent='å¤åˆ¶'},1500)});
                });
                code.parentElement.appendChild(btn);
            });
        })();
    </script>

</body>
</html>
